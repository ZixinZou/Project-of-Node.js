<% include common/header.ejs %>
  <style type="text/css">
    .answer{
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed #333;
    }
  </style>
  <p><a href="/">Retour à l'accueil</a></p>
  <h1>Les détails</h1>
  <p>Titre: <%=data[0].title %></p>
  <div><%=data[0].content %></div>
  <div class="reply">
    <h2>Commentaire</h2>
    <div class="reply_con">
      <table>
        <% for(var i=0, len=data[1].length; i<len; i++) {%>
          <tr>
            <td><%=(i+1) %></td>
            <td><%=data[1][i].content %></td>
            <td><%=data[1][i].createtime %></td>
          </tr>
        <% } %>
      </table>
    </div>
  </div>
  <div class="answer">
  <% if(user.username){ %>
    <textarea class="ans_con" cols="100" rows="10"></textarea>
    <p><input type="button" class="submit" data-titleid="<%=data[0].id %>" value="Soumettre"><span class="tip"></span></p>
    <script type="text/javascript" src="http://mat1.gtimg.com/libs/jquery/1.12.0/jquery.min.js"></script>
    <script type="text/javascript">
      var running = false;
      $('.submit').on('click', function(){
        if(running) return;
        running = true;
        $('.tip').text('');

        var ans_con = $('.ans_con').val();
        if(!ans_con){
          $('.tip').text('*L\'entrée ne peut pas être vide');
          return;
        }
        $('.tip').text('Les données sont en cours de soumission...');

        var titleid = $(this).data('titleid');

        $.ajax({
          url : '/list/addreply',
          data : {titleid:titleid, content:ans_con},
          dataType : 'json',
          type : 'get'
        }).done(function(result){
          if(result.code==0){
            var html = '<tr><td>'+result.data.rid+'</td><td>'+ans_con+'</td><td>'+result.data.createtime+'</td></tr>';
            $('.reply_con table').append(html);
            $('.tip').text('');
            $('.ans_con').val('');
          }else{
            $('.tip').text('La réponse a échoué');
          }
          running = false;
        })
      })
    </script>
  <% }else{%>
    <p>Veuillez vous connecter et répondre<a href="/user/login">Aller à la connexion</a></p>
  <% } %>
  </div>
<% include common/footer.ejs %>