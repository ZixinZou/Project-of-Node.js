<% include common/header.ejs %>
  <style type="text/css">
    .answer{
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed #333;
    }
  </style>
  <p><a href="/">Retour à l'accueil</a></p>
  <h1>Les détails</h1>
  <p>Titre: <%=data[0].title %></p>
  <div><%=data[0].content %></div>

  <div class="reply">
    <% if(user.username){ %>
    <h2>Start chatting!</h2>
    <div class="reply_con">
      <h1>Le super Chat temps réel !</h1>

      <form action="/" method="post" id="formulaire_chat">
        <input type="text" name="message" id="message" placeholder="Votre message..." size="50" autofocus />
        <input type="submit" id="envoi_message" value="Envoyer" />
      </form>

      <section id="zone_chat">

      </section>


      <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script>

          // Connexion à socket.io
          var socket = io.connect('http://localhost:3030');

          // On demande le pseudo, on l'envoie au serveur et on l'affiche dans le titre
          var pseudo = prompt('Quel est votre pseudo ?');
          socket.emit('nouveau_client', pseudo);
          document.title = pseudo + ' - ' + document.title;

          // Quand on reçoit un message, on l'insère dans la page
          socket.on('message', function(data) {
              insereMessage(data.pseudo, data.message)
          })

          // Quand un nouveau client se connecte, on affiche l'information
          socket.on('nouveau_client', function(pseudo) {
              $('#zone_chat').prepend('<p><em>' + pseudo + ' a rejoint le Chat !</em></p>');
          })

          // Lorsqu'on envoie le formulaire, on transmet le message et on l'affiche sur la page
          $('#formulaire_chat').submit(function () {
              var message = $('#message').val();
              socket.emit('message', message); // Transmet le message aux autres
              insereMessage(pseudo, message); // Affiche le message aussi sur notre page
              $('#message').val('').focus(); // Vide la zone de Chat et remet le focus dessus
              return false; // Permet de bloquer l'envoi "classique" du formulaire
          });

          // Ajoute un message dans la page
          function insereMessage(pseudo, message) {
              $('#zone_chat').prepend('<p><strong>' + pseudo + '</strong> ' + message + '</p>');
          }
      </script>
    </div>
      <% }else{%>
        <p>Veuillez vous connecter et répondre<a href="/user/login">Aller à la connexion</a></p>
      <% } %>
  </div>
<% include common/footer.ejs %>